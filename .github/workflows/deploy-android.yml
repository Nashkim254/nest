name: Deploy Android to Internal Testing

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy-android:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        cache: true
        
    - name: Get Flutter dependencies
      run: flutter pub get
      
    - name: Generate code
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: Run tests
      run: flutter test --no-pub --coverage --test-randomize-ordering-seed=random
      
    - name: Analyze code
      run: flutter analyze --no-pub
      
    - name: Decode keystore
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > nest-release-key.keystore
        
    - name: Build App Bundle
      env:
        KEYSTORE_PATH: nest-release-key.keystore
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: flutter build appbundle --release --build-number=${{ github.run_number }}
      
    - name: Upload to Google Play Internal Testing
      uses: r0adkll/upload-google-play@v1.1.3
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: com.nesthaps.nest
        releaseFiles: build/app/outputs/bundle/release/app-release.aab
        track: internal
        status: completed
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-release-${{ github.run_number }}
        path: |
          build/app/outputs/bundle/release/app-release.aab
          build/app/outputs/apk/release/app-release.apk